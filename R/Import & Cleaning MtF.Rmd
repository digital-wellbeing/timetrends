---
title: "MtF data import & cleaning"
author: "Augustin Mutak"
date: '10 03 2020 '
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Setup

Before doing the analyses, we need to set everything up, which includes loading the packages, merging the files, and so forth. Let's first import the packages (here's the alphabetical list, except for the plyr package, which has to be loaded before dplyr):

```{r packages, include = FALSE}
library(car)
library(plyr)
library(foreign)
library(haven)
library(janitor)
library(knitr)
library(labelled)
library(magrittr)
library(reshape2)
library(sjlabelled)
library(tidyverse)
```

#Data import and cleaning
##Monitoring the Future

Let's start by merging and cleaning the MtF data. Since we're not allowed to distribute the data - each user has to use the ICPSR website and agree to their terms - this script will assume that the user has done that and that all 400+ MTF files in the Stata format are downloaded and stored in the same directory, in this case it's **/Users/mutak/Dropbox/CSI Happiness Epidemic/Tidy/data/raw/MtF** (there can be subdirectories, but they all must be in the same folder). First we will import names of all the files:

Matti's changes:
- Paths are relative to R project (the root directory of this project)
- Reading the full names to simplify code below

```{r files}
MTFfiles <- list.files(
  path = "Raw data 2", 
  pattern = '\\.dta$', 
  recursive = T, 
  full.names = TRUE
)
```

After this, we have to list all the variables we want to examine in our study. We should do this by using labels of variables which can be found in the codebooks. The reason we're doing this is because label naming of the MTF dataset remained more or less consistend throughout the years, while variable naming isn't consistent. Therefore, we can merge the data from different years by using labels, but not by using variable names themselves. For now, let's go with the following variables:

```{r variables}
vars <- c('YEAR OF', 'S SEX', 's SEX', 'WHAT GRADE LEVL', 'VRY HPY THS DAY', 'SATISFD W MYSELF', 'LIFE MEANINGLESS', 'I ENJOY LIFE', 'HOPELESS', 'GOOD TO BE ALIVE', 'FUTR R LIFE WRSE', 'AM PRSN OF WORTH', 'DO WELL AS OTHRS', 'MUCH TO B PROUD', 'I AM NO GOOD', 'I DO WRONG THING', 'MY LIFE NT USEFL', 'POS ATT TWD SELF', 'OFTN FEEL LONELY', 'ALWYS SM1 HELP', 'OFTN FL LEFT OUT', 'USLY SM1 TALK TO', 'OFT WSH MOR FRND', 'USLY FRDS BE WTH', 'SAT LIFE AS WHL', 'CMP SATFD', 'PUTR SC', 'PUTR OT', 'PUTR JO', 'DAY HRS WATCH', 'END HRS WATCH', 'W GAMING', 'W INTERNET', 'TV/DAY', 'TV/WKEND')
```

Before proceeding with the merge, we have to create:

* An empty dataframe that will contain the merged data after the process is complete, which has the same number of columns as the number of our variables of interest and the columns are named accordingly;
* A list which will contain the data of interest from separate datafiles before it's merged;
* A list which will contain the labels of separate datafiles
* A vector which will contain column numbers of our variables of interest;
* A vector which will contain column names of our variables of interest;
* A vector which will contain column numbers of columns that are unlabelled and should be removed.

```{r placeholders}
MTF<-data.frame(matrix(ncol = length(vars)))
colnames(MTF)<-vars

intermediate<-list()

labels<-list()

indices<-vector('numeric')

names<-vector('character')
```

Now we can go ahead with the merge. Please see inline comments for detailed descriptions!

```{r merge, results = 'hide'}
for (i in 1:length(MTFfiles)){
  #Importing the file and adding it to the intermediate list
  # Matti: This was simplified with full file paths
  intermediate[[i]]<-read_dta(MTFfiles[i])
  #Checking if the Grade variable is present in the file; if not, it's 12th grade
  if (any(grepl("WHAT GRADE LEVEL", unlist(var_label(intermediate[[i]])))) == F){
    intermediate[[i]][,(ncol(intermediate[[i]])+1)]<-12
    var_label(intermediate[[i]][ncol(intermediate[[i]])])<-'WHAT GRADE LEVL'
  }
  #Extracting labels while making sure that unlabelled columns are not dropped from the indexing
  labels[[i]]<-var_label(intermediate[[i]])
  labels[[i]][sapply(labels[[i]], is.null)]<-NA
  labels[[i]]<-unlist(labels[[i]])
  for (j in 1:length(vars)){
    #Extracting the column numbers of variables of interest
    indices<-c(indices,grep(vars[j],labels[[i]]))
    #Extracting the column names of variables of interest
    names<-c(names,regmatches(labels[[i]],regexpr(vars[j],labels[[i]])))
  }
  #Removing all variables from the file except those we have chosen
  intermediate[[i]]<-intermediate[[i]][,indices]
  #Assigning labels as variable names so data can be merged
  colnames(intermediate[[i]])<-names
  #Cleaning the vectors
  indices<-vector('numeric')
  names<-vector('character')
 #Console output to track the progess
  cat('\r',paste0('Data from file ',i,' of ',length(MTFfiles),' extracted (', format(round(i/length(MTFfiles)*100,2), nsmall = 2),'%).'))
  flush.console()
}

#Merging the data in the main dataframe
MTF <- plyr::rbind.fill(intermediate)
```

After merging the files, there are some leftover things we still have to do:

* Variables with the labels 'SAT LIFE AS WHL' and 'CMP SATFD' are actually the same variable and they should be merged;
* The above also applies to variables with the labels 'S SEX' and 's SEX';
* Numerical values which indicate various types of missing data have to be removed (i.e., coded as NA);
* Cases which contain data only for 3 variables (year of administration, gender and grade) have to be removed;
* Cases which have unidentified labels for the Sex variable (3, 4, 5, 6 and 7) will be dropped;
* Cases which have unidentified labels for the Grade variable (3, 5, 6 and 7) will be dropped;
* Cases which have missing values in the Year variable should be dropped;
* Initial row numbers should be dropped;
* Values of years which were coded using only last two digits (e.g. 92 instead of 1992) have to be corrected;
* Sex variable has to be recoded from 1 and 2 to Male and Female, respectively;
* In the Grade variable, values of 2 and 4 have to ve recoded to 8 and 10, respectively;
* Labels have to be removed from the data (we'll add new, more meaningful ones later);
* All unnecessary variables which were used in the merging process have to be removed to save memory and space;
* Categorical variables will be turned to factors;
* Some columns are not numeric for some reason and they should be, so we'll make sure that everything except the year, grade and sex is numeric;
* We will sort the data by year of administration.

```{r leftovers}
MTF$`SAT LIFE AS WHL`<-rowSums(MTF[,c("SAT LIFE AS WHL", "CMP SATFD")], na.rm = T)
MTF<-subset(MTF, select = -`CMP SATFD`)
vars<-vars[-26]

MTF$`S SEX`<-rowSums(MTF[,c("S SEX", "s SEX")], na.rm = T)
MTF<-subset(MTF, select = -`s SEX`)
vars<-vars[-3]

MTF[MTF==0]<-NA
MTF[MTF==8]<-NA 
MTF[MTF==9]<-NA 
MTF[MTF==-9]<-NA
MTF[MTF==-8]<-NA

MTF<-MTF[!rowSums(is.na(MTF[,c(4:length(vars))]))==(length(vars)-3),]

MTF<-subset(MTF,`S SEX`==1|`S SEX`==2)

MTF<-subset(MTF,`WHAT GRADE LEVL`==2|`WHAT GRADE LEVL`==4|`WHAT GRADE LEVL`==12)

MTF<-drop_na(MTF, `YEAR OF`)

rownames(MTF)<-NULL

MTF$`YEAR OF`<-car::recode(MTF$`YEAR OF`,'76=1976;77=1977;78=1978;79=1979;80=1980;81=1981;82=1982;83=1983;84=1984;85=1985;86=1986;87=1987;88=1988;89=1989;90=1990;91=1991;92=1992;93=1993;94=1994;95=1995;96=1996;97=1997;98=1998')

MTF$`S SEX`[MTF$`S SEX`==1]<-'Male'
MTF$`S SEX`[MTF$`S SEX`==2]<-'Female'

MTF$`WHAT GRADE LEVL`<-car::recode(MTF$`WHAT GRADE LEVL`,'2=8;4=10')

rm(i,indices,j,labels,MTFfiles,vars,names,intermediate)

MTF$`YEAR OF`<-as.factor(MTF$`YEAR OF`)
MTF$`S SEX`<-as.factor(MTF$`S SEX`)
MTF$`WHAT GRADE LEVL`<-as.factor(MTF$`WHAT GRADE LEVL`)

MTF[,c(4:33)]<-as.numeric(as.matrix(MTF[,c(4:33)]))

MTF<-arrange(MTF, `YEAR OF`)
```

We have a pretty large file! Before proceeding further, let's add meaningful names and labels to our variables. The notation of the variables will be the following:

* Year, sex and grade - self-explanatory
* Prefix 'SE' - Items from Rosenberg's Self-Esteem Scale
* Prefix 'D' - Items from Depression scale of the Bentler Medical and Psychological Functioning Inventory
* Prefix 'L' - Loneliness scale
* H - Happiness
* S - Life satisfaction
* F - Future outlook

```{r names}
colnames(MTF)<-c('Year','Sex', 'Grade', 'H', 'S', 'SE_R_1', 'SE_R_7', 'SE_R_4', 'SE_R_5', 'SE_R_2', 'D_B_1', 'D_B_2', 'SE_R_10', 'F',  'TV/WEEKDAY', 'L_MTF_1', 'L_MTF_2', 'L_MTF_3', 'L_MTF_4', 'L_MTF_5', 'L_MTF_6', 'D_B_3', 'D_B_4', 'D_B_5', 'D_B_6', 'TV/WEEKEND', 'COMPUTER/SCHOOL', 'COMPUTER/OTHER', 'COMPUTER JOB', 'INTERNET/WEEK', 'GAMING/WEEK', 'SCREENTIME/WEEKDAY', 'SCREENTIME/WEEKEND')
```

Let's also recode the items, so that all the responses indicate higher development of the construct - higher self-esteem, higher loneliness, more depressive symptoms. We'll also assign labels to those variables.

```{r}
MTF$SE_R_5<-car::recode(MTF$SE_R_5, '1=5;2=4;4=2;5=1')
MTF$SE_R_2<-car::recode(MTF$SE_R_2, '1=5;2=4;4=2;5=1')
MTF$L_MTF_2<-car::recode(MTF$L_MTF_2, '1=5;2=4;4=2;5=1')
MTF$L_MTF_4<-car::recode(MTF$L_MTF_4, '1=5;2=4;4=2;5=1')
MTF$L_MTF_6<-car::recode(MTF$L_MTF_6, '1=5;2=4;4=2;5=1')
MTF$D_B_4<-car::recode(MTF$D_B_4, '1=5;2=4;4=2;5=1')
MTF$D_B_6<-car::recode(MTF$D_B_6, '1=5;2=4;4=2;5=1')
# Matti: Replace with
# MTF <- mutate_at(MTF, vars(SE_R_5, SE_R_2, L_MTF_2, L_MTF_4, L_MTF_6, D_B_4, D_B_6), ~6-.)
```

Finally, we can export the file:

Matti: Instead of a csv we're exporting a serialized object that keeps attributes

```{r export}
saveRDS(MTF, "mtf-clean.rds")
```
