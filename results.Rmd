---
title: ""
author: "Matti Vuorre"
date: "`r Sys.Date()`"
output: 
  html_document:
    self_contained: true
    toc: true
    toc_depth: 2
    toc_float: true
    theme: simplex
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
opts_chunk$set(
  cache = FALSE,
  cache.lazy = FALSE,
  echo = FALSE,
  message = FALSE, 
  warning = FALSE,
  fig.width = 8,
  fig.height = 6,
  fig.retina = 2
)
theme_set(
  theme_linedraw() + 
    theme(
      panel.grid.minor = element_blank()
    )
)
```

# Monitoring the Future

```{r}
# Read processed data from drake's cache
loadd("mtf_aggregated")
```

We look at the relationship between well-being (depression, loneliness, and self esteem) and technology use (social media and tv) longitudinally in the Monitoring the Future dataset.

```{r data-figure}
# Plot all measures' averages across time
mtf_aggregated %>%
  mutate(grade = paste("Grade", grade)) %>% 
  mutate(grade = factor(grade, levels = c("Grade 8", "Grade 10", "Grade 12"))) %>% 
  pivot_longer(c(social_media, tv, self_esteem:loneliness)) %>% 
  drop_na(value) %>% 
  ggplot(aes(year, value, col = name, fill = name)) +
  scale_color_brewer(
    "Measure",
    palette = "Dark2", aesthetics = c("color", "fill")
  ) +
  scale_y_continuous(
    "Mean value",
    breaks = pretty_breaks(),
  ) +
  scale_x_continuous(
    "Year", breaks = pretty_breaks()
  ) +
  stat_summary(fun = mean, geom = "line", size = .8) +
  labs(caption = "TV is measured on a 1-7 scale, all others on 1-5 scales") +
  facet_grid(sex~grade)
```

## Social media

Social media use is measured with a single 1-5 item.

### Model 1

Predict standardized depression, loneliness, and self-esteem from standardized social media separately for each year, sex, and grade. This shows the well-being - social media relationships with the least assumptions.

More precisely, we fit $y_i \sim N(\alpha + \beta \text{social media}_i, \sigma^2)$ (`lm(y ~ x)`) separately to each of the three outcomes and for every combination of sex, grade, and year.

```{r sm-model-1}
# Fit models and plot estimated parameters
# Prep data
sm <- mtf_aggregated %>% 
  select(year:grade, social_media, self_esteem:loneliness) %>% 
  mutate_at(.vars = vars(social_media:loneliness), ~scale(.)[,1]) %>% 
  pivot_longer(self_esteem:loneliness, names_to = "scale", values_to = "y") %>% 
  drop_na(y, social_media) %>% 
  mutate(grade = factor(grade, levels = c(8, 10, 12)))
# Fit models to sex by grade by year by scale
fits_lm <- sm %>% 
  group_by(sex, grade, year, scale) %>% 
  nest() %>% 
  mutate(fit = map(data, ~lm(y ~ social_media, data = .))) %>% 
  select(-data)
# Fit model ignoring sex (i.e. to average sex)
fits_lm2 <- sm %>% 
  mutate(sex = "Average") %>%
  group_by(sex, grade, year, scale) %>% 
  nest() %>% 
  mutate(fit = map(data, ~lm(y ~ social_media, data = .))) %>% 
  select(-data)
# Put fits together and plot estimates
fits_lm <- bind_rows(fits_lm, fits_lm2)
fits_lm %>% 
  # Evaluate null hypothesis for each model
  mutate(hypothesis = "social_media = 0") %>% 
  mutate(out = map2(fit, hypothesis, ~try(tidy(confint(glht(.x, .y)))))) %>% 
  unnest(out) %>% 
  ggplot(aes(year, estimate, col = grade)) +
  scale_color_brewer(palette = "Set1") +
  scale_x_continuous(breaks = 2012:2017, labels = paste0("'", 12:17)) +
  coord_cartesian(ylim = c(-.2, .2)) +
  geom_hline(yintercept = 0) +
  geom_pointinterval(
    aes(ymin = conf.low, ymax = conf.high), 
    position = position_dodge(.33),
    size = 2
  ) +
  facet_grid(sex~scale) +
  labs(y = "Estimated relationship with social media") +
  theme(legend.position = "bottom")
```

Social media looks consistently associated with worse outcomes for younger individuals and females. Overall, outcomes appear to be improving over time. Next, we fit models to estimate the timecourses of the outcomes and their relations to social media.

### Model 2

Predict standardized well-being from standardized social media, year and their interaction, separately for sexes and grades. This time we assume that year is a linear predictor to get estimates of temporal trends in the social media - well-being relationship.

More precisely, we fit $y_i \sim N(\alpha + \beta_1 \text{social media}_i + \beta_2 \text{year}_i + \beta_3 \text{social media}_i\times\text{year}_i, \sigma^2)$ (`lm(y ~ x * year)`) separately to each of the three outcomes and for every combination of sex and grade.

```{r sm-model-2}
fits_lm <- sm %>%
  # Center on year 2012
  mutate(year = year-2012) %>% 
  group_by(scale, grade, sex) %>% 
  nest() %>% 
  mutate(fit = map(data, ~lm(y ~ social_media*year, data = .)))
# Average sex
fits_lm2 <- sm %>% 
  mutate(year = year-2012) %>% 
  mutate(sex = "Average") %>%
  group_by(scale, grade, sex) %>% 
  nest() %>% 
  mutate(fit = map(data, ~lm(y ~ social_media*year, data = .)))
fits_lm <- bind_rows(fits_lm, fits_lm2) %>% select(-data)
fits_lm %>% 
  # Evaluate null hypothesis for each year
  expand_grid(nesting(year = 0:5, Year = 2012:2017)) %>% 
  # glht hack to avoid 0s by converting zero to practically zero
  mutate(year = ifelse(year==0, 1e-6, year)) %>% 
  mutate(hypothesis = glue("social_media + social_media:year*{year} = 0")) %>% 
  mutate(out = map2(fit, hypothesis, ~try(tidy(confint(glht(.x, .y)))))) %>% 
  unnest(out) %>% 
  mutate(year = ifelse(year==1e-6, 0, year)) %>% 
  ggplot(aes(year, estimate, col = grade)) +
  scale_color_brewer(palette = "Set1") +
  scale_x_continuous(breaks = 0:5, labels = paste0("'", 12:17)) +
  coord_cartesian(ylim = c(-.2, .2)) +
  geom_hline(yintercept = 0) +
  geom_pointinterval(
    aes(ymin = conf.low, ymax = conf.high), 
    position = position_dodge(.33),
    size = 2
  ) +
  facet_grid(sex~scale) +
  labs(y = "Estimated relationship with social media") +
  theme(legend.position = "bottom")
```

For all subgroups (sex and grades), the social-media - well-being relationship is becoming more positive over time. In 2017, social media use related positively to self esteem, and negatively to loneliness. The estimated social media by year interaction parameters (the magnitude of change in the social media - well being relation per decade) are shown below.

```{r sm-model-2-tab}
# Get social_media x year interaction (in decades) for each sex and grade
fits_lm %>% 
  mutate(hypothesis = "social_media:year*10 = 0") %>% 
  mutate(out = map2(fit, hypothesis, ~try(tidy(summary(glht(.x, .y)))))) %>% 
  unnest(out) %>% 
  mutate(
    res = as.character(glue(
      "b = {round(estimate, 2)}{ifelse(p.value<0.05, '*', '')} ({round(std.error, 2)})"
    ))
  ) %>% 
  select(scale, sex, grade, res) %>% 
  pivot_wider(names_from = sex, values_from = res) %>% 
  arrange(scale, grade) %>% 
  kable(digits = 2, caption = "Estimated social media by year interactions (in decades)")
```

## TV

### Model 1

Predict standardized depression, loneliness, and self-esteem from standardized TV viewing separately for each year, sex, and grade. This shows the TV - social media relationships with the least assumptions.

```{r tv-model-1}
tv <- mtf_aggregated %>% 
  select(year:grade, tv, self_esteem:loneliness) %>% 
  mutate_at(.vars = vars(tv:loneliness), ~scale(.)[,1]) %>% 
  pivot_longer(self_esteem:loneliness, names_to = "scale", values_to = "y") %>% 
  drop_na(y, tv) %>% 
  mutate(grade = factor(grade, levels = c(8, 10, 12)))
fits_lm <- tv %>% 
  group_by(sex, grade, year, scale) %>% 
  nest() %>% 
  mutate(fit = map(data, ~lm(y ~ tv, data = .)))
# Average sex
fits_lm2 <- tv %>% 
  mutate(sex = "Average") %>%
  group_by(sex, grade, year, scale) %>% 
  nest() %>% 
  mutate(fit = map(data, ~lm(y ~ tv, data = .)))
fits_lm <- bind_rows(fits_lm, fits_lm2) %>% select(-data)
fits_lm %>% 
  mutate(hypothesis = "tv = 0") %>% 
  mutate(out = map2(fit, hypothesis, ~try(tidy(confint(glht(.x, .y))), silent = TRUE))) %>% 
  unnest(out) %>% 
  ggplot(aes(year, estimate, col = grade)) +
  scale_color_brewer(palette = "Set1") +
  scale_x_continuous(breaks = pretty_breaks()) +
  coord_cartesian(ylim = c(-.2, .2)) +
  geom_hline(yintercept = 0) +
  geom_pointinterval(
    aes(ymin = conf.low, ymax = conf.high), 
    position = position_dodge(.33),
    size = 1
  ) +
  facet_grid(sex~scale) +
  labs(y = "Estimated relationship with TV viewing") +
  theme(legend.position = "bottom")
```

### Model 2

Predict standardized well-being from standardized TV viewing, year and their interaction, separately for sexes and grades. This time we assume that year is a linear predictor to get estimates of temporal trends in the TV - well-being relationship.

```{r tv-model-2}
fits_lm <- tv %>%
  # Center on year 2000
  mutate(year = year-2000) %>% 
  group_by(scale, grade, sex) %>% 
  nest() %>% 
  mutate(fit = map(data, ~lm(y ~ tv*year, data = .)))
# Average sex
fits_lm2 <- tv %>% 
  mutate(year = year-2000) %>% 
  mutate(sex = "Average") %>%
  group_by(scale, grade, sex) %>% 
  nest() %>% 
  mutate(fit = map(data, ~lm(y ~ tv*year, data = .)))
fits_lm <- bind_rows(fits_lm, fits_lm2) %>% select(-data)
tmp <- fits_lm %>% 
  expand_grid(nesting(year = sort(unique(tv$year))-2000)) %>% 
  # glht hack
  mutate(year = ifelse(year==0, 1e-6, year)) %>% 
  mutate(hypothesis = as.character(glue("tv + tv:year*{year} = 0"))) %>% 
  mutate(out = map2(fit, hypothesis, ~try(tidy(confint(glht(.x, .y))), silent = TRUE))) %>% 
  unnest(out) %>% 
  mutate(year = ifelse(year==1e-6, 0, year))
tmp %>%   
  ggplot(aes(year, estimate, col = grade, fill = grade)) +
  scale_color_brewer(palette = "Set1", aesthetics = c("color", "fill")) +
  scale_x_continuous(breaks = seq(1980, 2020, by = 10)-2000, labels = seq(1980, 2020, by = 10)) +
  coord_cartesian(ylim = c(-.2, .2)) +
  geom_hline(yintercept = 0) +
  geom_line() +
  geom_ribbon(
    aes(ymin = conf.low, ymax = conf.high), 
    alpha = .2, col = NA
  ) +
  facet_grid(sex~scale) +
  labs(y = "Estimated relationship with TV") +
  theme(legend.position = "bottom")
```

For all subgroups (sex and grades), the TV - well-being relationship is becoming more positive over time. The estimated TV by year interaction parameters (the magnitude of change in the TV - well being relation per decade) are shown below.

```{r tv-model-2-tab}
# Get TV x year interaction for each sex and grade
fits_lm %>% 
  mutate(hypothesis = "tv:year*10 = 0") %>% 
  mutate(out = map2(fit, hypothesis, ~try(tidy(summary(glht(.x, .y))), silent = TRUE))) %>% 
  unnest(out) %>% 
  mutate(
    res = as.character(glue(
      "b = {round(estimate, 2)}{ifelse(p.value<0.05, '*', '')} ({round(std.error, 2)})"
    ))
  ) %>% 
  select(scale, sex, grade, res) %>% 
  pivot_wider(names_from = sex, values_from = res) %>% 
  arrange(scale, grade) %>% 
  kable(digits = 2, caption = "Estimated TV by year interactions (in decades)")
```
